@startuml C4_Container
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml


Person(user_person, "User", "Reddit user")

System_Boundary(c1, "Reddit system") {
    Container(spa, "Single-Page Application", "NextJS", "Frontend.",)

    Container(gateway, "Gateway", "Nginx", "Routes requests")

    Container(auth, "Auth", "FastAPI", "Ensures requests are authenticated")

    Container(user, "User", "FastAPI", "Handles all user requests")
    ContainerDb(user_db, "User database", "PostgreSQL", "Holds user information.")

    Container(comment, "Comment", "FastAPI", "Handles all comment requests")
    ContainerDb(comment_db, "Comment database", "PostgreSQL", "Holds comment information.")

    Container(post, "Post", "FastAPI", "Handles all post requests")
    ContainerDb(post_db, "Post database", "PostgreSQL", "Holds post information.")

    Container(vote, "Vote", "FastAPI", "Handles all vote requests")
    ContainerDb(vote_db, "Vote database", "PostgreSQL", "Holds vote information.")

    Container(email, "Email", "Python3", "Microservice for emails.")
    Container(rabbitmq, "RabbitMQ", "RabbitMQ", "Message broker for microservices.")
}

System_Ext(azure_ad, "Microsoft Azure AD", "OAuth2.0 provider.")
System_Ext(email_communication_service, " Microsoft Azure Email Communication Service", "Sends emails on behalf of not-reddit")
SystemDb_Ext(blob_storage, "Microsoft Azure Blob Storage", "Storage for images and videos.")

Rel(spa, azure_ad, "Gets access token from", "OAuth2.0")

Rel(user_person, spa, "Uses", "HTTPS")

Rel(spa, gateway, "Uses", "HTTPS")

Rel(gateway, user, "Routes to", "HTTPS")
Rel(gateway, comment, "Routes to", "HTTPS")
Rel(gateway, post, "Routes to", "HTTPS")
Rel(gateway, vote, "Routes to", "HTTPS")
Rel_R(gateway, auth, "Routes to", "HTTPS")

Rel_R(auth, azure_ad, "Authenticates with", "OAuth2.0")

Rel_D(user, user_db, "Reads/Writes", "SQLAlchemy")
Rel_L(user, rabbitmq, "Sends", "AMQP")

Rel(comment, comment_db, "Reads/Writes", "SQLAlchemy")

Rel(post, post_db, "Reads/Writes", "SQLAlchemy")
Rel_R(post, blob_storage, "Reads/Writes", "HTTPS")

Rel(vote, vote_db, "Reads/Writes", "SQLAlchemy")

Rel_R(email, rabbitmq, "Consumes", "AMQP")
Rel_L(email, email_communication_service, "Sends", "SMTP")

Lay_R(vote, post)
Lay_R(comment,post)

@enduml
